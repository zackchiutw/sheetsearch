<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>產品查詢 App (響應式)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* 自訂 iOS 風格樣式 */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            margin: 0;
            background-color: #f0f0f0; /* iOS 背景灰 */
            display: flex; /* 使用 Flexbox 讓容器垂直和水平居中 */
            justify-content: center;
            align-items: center;
            min-height: 100vh; /* 確保 body 至少和視窗一樣高 */
            color: #333;
            padding: 1rem; /* 在 body 周圍添加一些間距，避免容器緊貼邊緣 */
            box-sizing: border-box;
        }

        .ios-app-container {
            width: 100%; /* 容器寬度佔滿父元素 (body 的 padding 內) */
            margin-left: auto; /* 自動外邊距實現水平居中 */
            margin-right: auto;
            background-color: #ffffff; /* iOS 常用白色背景 */
            border-radius: 20px; /* iOS 圓角風格 */
            box-shadow: 0 8px 30px rgba(0,0,0,0.1);
            overflow: hidden; /* 隱藏超出圓角的內容 */
            display: flex;
            flex-direction: column;

            /* 手機優先：預設為類似手機的尺寸 */
            max-width: 480px; /* 手機上的最大寬度 */
            height: 100vh;    /* 在小螢幕上，讓容器盡可能佔滿視窗高度 */
            max-height: 850px; /* 但也設定一個最大高度，避免在某些手機上過長 */
        }

        /* 中等螢幕及以上 (例如：平板、較大的手機橫向模式) */
        @media (min-width: 640px) { /* Tailwind sm breakpoint */
            .ios-app-container {
                max-width: 520px; /* 稍微增加最大寬度 */
                /* 在較大螢幕上，讓內容決定高度，而不是強制佔滿視窗 */
                height: auto;
                min-height: 500px; /* 設定一個合理的最小高度 */
                max-height: 90vh; /* 最大高度為視窗高度的90%，上下留有空間 */
                margin-top: 2rem;   /* 在上下增加一些外邊距 */
                margin-bottom: 2rem;
                border-radius: 24px; /* 圓角稍微調整 */
                box-shadow: 0 12px 40px rgba(0,0,0,0.12); /* 陰影調整 */
            }
        }

        /* 大型螢幕 (例如：桌上型電腦) */
        @media (min-width: 1024px) { /* Tailwind lg breakpoint */
            .ios-app-container {
                max-width: 580px; /* 桌機上可以再寬一些，但仍保持 App 的感覺 */
                border-radius: 28px;
            }
        }

        .page {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .ios-header {
            background-color: #f8f8f8; /* iOS 導覽列淺灰色 */
            padding: 12px 16px;
            border-bottom: 1px solid #d1d1d1;
            display: flex;
            justify-content: space-between;
            align-items: center;
            min-height: 50px; /* 導覽列最小高度 */
            flex-shrink: 0; /* 防止頭部在 flex 佈局中被壓縮 */
        }

        .ios-header-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #000;
        }

        .ios-content {
            padding: 16px;
            overflow-y: auto; /* 內容超出時垂直滾動 */
            flex-grow: 1;     /* 佔據剩餘的垂直空間 */
            background-color: #f9f9f9;
            -webkit-overflow-scrolling: touch; /* iOS 上流暢滾動 */
        }

        .ios-input {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1rem;
            margin-bottom: 16px;
            box-shadow: inset 0 1px 2px rgba(0,0,0,0.05);
        }
        .ios-input:focus {
            outline: none;
            border-color: #007aff;
            box-shadow: 0 0 0 2px rgba(0,122,255,0.2);
        }

        .ios-button {
            background-color: #007aff;
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            text-align: center;
            transition: background-color 0.2s;
            width: 100%;
        }
        .ios-button:hover {
            background-color: #005bb5;
        }
        .ios-button-secondary {
            background-color: #e5e5ea;
            color: #007aff;
        }
        .ios-button-secondary:hover {
            background-color: #dcdce0;
        }

        /* 表格結果列表的容器 */
        .ios-list {
            overflow-x: auto; /* 當表格內容超出容器寬度時，允許水平滾動 */
            -webkit-overflow-scrolling: touch; /* iOS 上流暢滾動 */
            border-radius: 8px; /* 為滾動區域添加圓角 */
            background-color: #fff; /* 給列表一個背景色，避免滾動時下方內容透出 */
            box-shadow: 0 2px 4px rgba(0,0,0,0.05); /* 給列表輕微的陰影 */
        }

        .ios-list table {
            width: 100%; /* 表格寬度充滿其容器 (.ios-list) */
            /* min-width: 500px; */ /* 可選：為表格設定一個最小寬度，防止欄位過於擁擠。如果設定，則在小螢幕上一定會觸發水平滾動 */
            border-collapse: collapse; /* 合併儲存格邊框 */
        }
        .ios-list th, .ios-list td {
            padding: 10px 12px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
            font-size: 0.9rem;
            white-space: nowrap; /* 防止儲存格內容換行，確保橫向滾動時格式正確 */
        }
        .ios-list th {
            background-color: #f0f0f0;
            font-weight: 500;
            color: #555;
            position: sticky; /* 讓表頭在垂直滾動時固定 (如果 .ios-content 滾動) */
            top: 0; /* 配合 sticky 定位 */
            z-index: 1; /* 確保表頭在其他內容之上 */
        }
        .ios-list td {
            background-color: #fff;
            color: #333;
        }
        .ios-list tr:last-child td {
            border-bottom: none; /* 最後一行的儲存格移除底部邊框 */
        }
        .ios-list .no-results {
            padding: 20px;
            text-align: center;
            color: #888;
            background-color: #fff;
            white-space: normal; /* 允許 "無結果" 的訊息換行 */
        }

        .hidden {
            display: none !important;
        }
        
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #007aff;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

    </style>
</head>
<body>
    <div id="app" class="ios-app-container">
        <div id="loginPage" class="page p-8 flex flex-col justify-center">
            <h1 class="text-3xl font-bold text-center mb-8 text-gray-800">產品查詢系統</h1>
            <input type="text" id="username" placeholder="使用者名稱 (任意輸入)" class="ios-input mb-4">
            <input type="password" id="password" placeholder="密碼 (任意輸入)" class="ios-input mb-6">
            <button id="loginButton" class="ios-button">登入</button>
        </div>

        <div id="mainPage" class="page hidden">
            <header class="ios-header">
                <h1 class="ios-header-title">產品查詢</h1>
                <button id="logoutButton" class="text-sm text-red-500 hover:text-red-700 font-medium">登出</button>
            </header>
            <main class="ios-content">
                <div class="mb-4">
                    <input type="text" id="searchInput" placeholder="輸入關鍵字搜尋產品..." class="ios-input">
                </div>
                <div id="loadingIndicator" class="hidden">
                    <div class="loader"></div>
                    <p class="text-center text-gray-600">正在載入資料...</p>
                </div>
                <div id="errorMessage" class="hidden p-4 text-center text-red-600 bg-red-100 rounded-lg"></div>
                <div id="resultsList" class="ios-list">
                    </div>
            </main>
        </div>
    </div>

    <script>
        // Google Sheet 設定
        const SHEET_ID = '1sxAYg3k2ZDV8zulv67U1O9TS5NF5cuMfuisHWz8FXkU';
        const SHEET_NAME = '20250514'; // 請確保這是您正確的工作表名稱
        const API_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(SHEET_NAME)}`;

        // DOM 元素
        const loginPage = document.getElementById('loginPage');
        const mainPage = document.getElementById('mainPage');
        const loginButton = document.getElementById('loginButton');
        const logoutButton = document.getElementById('logoutButton');
        const searchInput = document.getElementById('searchInput');
        const resultsList = document.getElementById('resultsList');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const errorMessage = document.getElementById('errorMessage');

        console.log('DOM Element - loginPage:', loginPage);
        console.log('DOM Element - mainPage:', mainPage);
        console.log('DOM Element - loginButton:', loginButton);
        // ... (其餘的 console.log 和 JavaScript 邏輯保持不變) ...
        if (!loginPage || !mainPage || !loginButton || !errorMessage || !loadingIndicator || !resultsList) {
            const missingElements = [
                !loginPage && "loginPage",
                !mainPage && "mainPage",
                !loginButton && "loginButton",
                !errorMessage && "errorMessage",
                !loadingIndicator && "loadingIndicator",
                !resultsList && "resultsList"
            ].filter(Boolean).join(", ");
            
            const criticalErrorMsg = `應用程式初始化失敗：一個或多個必要的頁面元素未找到 (${missingElements})。請檢查 HTML 中的 ID 是否與 JavaScript 中的一致，並查看瀏覽器控制台。`;
            console.error(criticalErrorMsg);
            // alert(criticalErrorMsg); // 避免在生產環境中使用 alert
        }

        let sheetData = { headers: [], data: [] };

        function parseCSVLine(line) {
            const regex = /(?:\"([^\"]*(?:\"\"[^\"]*)*)\"|([^\",]+))/g;
            let values = [];
            let match;
            while (match = regex.exec(line)) {
                if (match[1] !== undefined) {
                    values.push(match[1].replace(/\"\"/g, '\"'));
                } else {
                    values.push(match[2]);
                }
            }
            return values;
        }

        function parseCSV(csvText) {
            if (typeof csvText !== 'string') {
                console.error("parseCSV 接收到的不是字串:", csvText);
                return { headers: [], data: [] };
            }
            const lines = csvText.trim().split('\n');
            const data = [];
            let headers = [];

            if (lines.length > 0) {
                headers = parseCSVLine(lines[0]);
                for (let i = 1; i < lines.length; i++) {
                    if (lines[i].trim() === "") continue;
                    const cells = parseCSVLine(lines[i]);
                    if (cells.length === headers.length && cells.some(cell => cell && cell.trim() !== "")) {
                        let rowObject = {};
                        headers.forEach((header, index) => {
                            rowObject[header] = cells[index] || '';
                        });
                        data.push(rowObject);
                    } else {
                        console.warn(`parseCSV: 第 ${i+1} 行資料欄位數 (${cells.length}) 與表頭欄位數 (${headers.length}) 不符，或為空行，已跳過:`, lines[i]);
                    }
                }
            }
            return { headers, data };
        }

        async function fetchSheetData() {
            console.log('fetchSheetData: 函數已呼叫。');
            if (!loadingIndicator || !errorMessage || !resultsList) {
                console.error('fetchSheetData: 必要的 UI 元素 (loadingIndicator, errorMessage, resultsList) 未找到!');
                // alert('資料載入元件初始化錯誤，請檢查瀏覽器控制台。'); // 避免 alert
                return;
            }

            loadingIndicator.classList.remove('hidden');
            errorMessage.classList.add('hidden');
            resultsList.innerHTML = '';
            
            try {
                console.log('fetchSheetData: 開始 fetch 資料從 API_URL:', API_URL);
                const response = await fetch(API_URL);
                console.log('fetchSheetData: fetch 請求完成，回應狀態:', response.status, response.statusText);

                if (!response.ok) {
                    const errorText = await response.text(); 
                    console.error('fetchSheetData: 伺服器回應錯誤:', response.status, response.statusText, errorText);
                    throw new Error(`無法載入資料: ${response.status} ${response.statusText}. 伺服器訊息: ${errorText.substring(0,100)}...`);
                }
                const csvText = await response.text();
                console.log('fetchSheetData: CSV 文字資料已獲取，長度:', csvText.length);
                if (csvText.length < 1000) { 
                    console.log('fetchSheetData: CSV 內容 (前1000字元):', csvText.substring(0,1000));
                }

                sheetData = parseCSV(csvText);
                console.log('fetchSheetData: CSV 解析完成。表頭:', sheetData.headers, '資料筆數:', sheetData.data.length);

                if (!sheetData.headers || sheetData.headers.length === 0) {
                     console.error('fetchSheetData: 無法解析表頭或工作表為空。');
                     throw new Error('無法解析表頭或工作表為空。請檢查工作表內容和 CSV 格式。');
                }
                if (sheetData.data.length === 0) {
                    console.log('fetchSheetData: 工作表中目前沒有資料。');
                    resultsList.innerHTML = '<div class="no-results">工作表中目前沒有資料。</div>';
                } else {
                    console.log('fetchSheetData: 資料載入成功，準備顯示結果。');
                    displayResults(sheetData.data);
                }
            } catch (error) {
                console.error("fetchSheetData: 載入 Google Sheet 資料時發生錯誤 (詳細資訊):", error);
                if (errorMessage) {
                    errorMessage.textContent = `錯誤: ${error.message} 請確認 Google Sheet ID、工作表名稱是否正確、共用權限已設為「知道連結的任何人皆可檢視」，並檢查您的網路連線。詳細錯誤請見瀏覽器控制台。`;
                    errorMessage.classList.remove('hidden');
                } else {
                    console.error("fetchSheetData: 'errorMessage' 元素未找到，無法在頁面顯示錯誤訊息。");
                }
                if (resultsList) {
                    resultsList.innerHTML = '<div class="no-results">無法載入產品資料。</div>';
                }
            } finally {
                console.log('fetchSheetData: finally 區塊執行，隱藏載入指示器。');
                if (loadingIndicator) {
                    loadingIndicator.classList.add('hidden');
                }
            }
        }

        function filterAndDisplayData() {
            const searchTerm = searchInput.value.toLowerCase().trim();
            if (!sheetData.data || sheetData.data.length === 0) {
                if (loadingIndicator && !loadingIndicator.classList.contains('hidden')) {
                    return;
                }
                resultsList.innerHTML = '<div class="no-results">沒有可供搜尋的資料。</div>';
                return;
            }

            const filteredData = sheetData.data.filter(row => {
                if (!searchTerm) return true;
                return Object.values(row).some(value =>
                    String(value).toLowerCase().includes(searchTerm)
                );
            });
            displayResults(filteredData);
        }
        
        function escapeHTML(str) {
            if (str === null || str === undefined) return '';
            return String(str)
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        function displayResults(dataToDisplay) {
            resultsList.innerHTML = ''; 
            if (errorMessage) errorMessage.classList.add('hidden');

            if (dataToDisplay.length === 0) {
                resultsList.innerHTML = '<div class="no-results">未找到符合條件的產品。</div>';
                return;
            }

            const table = document.createElement('table');
            const thead = document.createElement('thead');
            let headerRowHtml = '<tr>';
            sheetData.headers.forEach(header => {
                headerRowHtml += `<th>${escapeHTML(header)}</th>`;
            });
            headerRowHtml += '</tr>';
            thead.innerHTML = headerRowHtml;
            table.appendChild(thead);

            const tbody = document.createElement('tbody');
            dataToDisplay.forEach(rowObject => {
                let rowHtml = '<tr>';
                sheetData.headers.forEach(header => {
                    const cellValue = rowObject[header];
                    rowHtml += `<td>${escapeHTML(cellValue)}</td>`;
                });
                rowHtml += '</tr>';
                tbody.innerHTML += rowHtml;
            });
            table.appendChild(tbody);
            resultsList.appendChild(table);
        }

        if (loginButton) {
            loginButton.addEventListener('click', () => {
                console.log('事件監聽: 登入按鈕被點擊。');
                if (!loginPage || !mainPage) {
                    console.error('事件監聽 (登入): loginPage 或 mainPage 元素未找到!');
                    return;
                }
                loginPage.classList.add('hidden');
                mainPage.classList.remove('hidden');
                console.log('事件監聽 (登入): 頁面已切換，準備呼叫 fetchSheetData。');
                fetchSheetData();
            });
        } else {
            console.error("事件監聽: 'loginButton' 未找到，無法附加點擊事件。");
        }

        if (logoutButton) {
            logoutButton.addEventListener('click', () => {
                console.log('事件監聽: 登出按鈕被點擊。');
                if (!mainPage || !loginPage) {
                    console.error('事件監聽 (登出): mainPage 或 loginPage 元素未找到!');
                    return;
                }
                mainPage.classList.add('hidden');
                loginPage.classList.remove('hidden');
                if (searchInput) searchInput.value = '';
                if (resultsList) resultsList.innerHTML = '';
                sheetData = { headers: [], data: [] };
                if (errorMessage) errorMessage.classList.add('hidden');
            });
        } else {
            console.error("事件監聽: 'logoutButton' 未找到，無法附加點擊事件。");
        }
        
        if (searchInput) {
            let searchTimeout;
            searchInput.addEventListener('input', () => {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    console.log('事件監聽 (搜尋): 搜尋輸入框內容變更，執行 filterAndDisplayData。');
                    filterAndDisplayData();
                }, 300);
            });
        } else {
            console.error("事件監聽: 'searchInput' 未找到，無法附加輸入事件。");
        }
    </script>
</body>
</html>
