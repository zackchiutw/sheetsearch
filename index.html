<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>產品查詢 App (Auth0 登入 - 自動載入工作表按鈕)</title>

    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#007aff">

    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="產品查詢">
    <link rel="apple-touch-icon" href="icons/apple-touch-icon.png"> 

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.auth0.com/js/auth0-spa-js/2.1/auth0-spa-js.production.js"></script>
    <style>
        /* 自訂 iOS 風格樣式 */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            margin: 0;
            background-color: #f0f0f0; /* iOS 背景灰 */
            display: flex; 
            justify-content: center;
            align-items: center;
            min-height: 100vh; 
            color: #333;
            padding: 1rem; 
            box-sizing: border-box;
        }

        .ios-app-container {
            width: 100%; 
            margin-left: auto; 
            margin-right: auto;
            background-color: #ffffff; 
            border-radius: 20px; 
            box-shadow: 0 8px 30px rgba(0,0,0,0.1);
            overflow: hidden; 
            display: flex;
            flex-direction: column;
            max-width: 480px; /* 手機上的最大寬度 */
            height: 100vh;    /* 在小螢幕上，讓容器盡可能佔滿視窗高度 */
            max-height: 850px; 
        }

        @media (min-width: 640px) { /* sm */
            .ios-app-container {
                max-width: 600px; 
                height: auto; 
                min-height: 500px; 
                max-height: 90vh; 
                margin-top: 2rem;   
                margin-bottom: 2rem;
                border-radius: 24px; 
                box-shadow: 0 12px 40px rgba(0,0,0,0.12); 
            }
        }
        @media (min-width: 768px) { /* md */
            .ios-app-container {
                max-width: 720px; 
            }
        }
        @media (min-width: 1024px) { /* lg, PC 版本 */
            .ios-app-container {
                max-width: 960px; 
                border-radius: 28px; 
            }
            .ios-list { /* 表格容器的 PC 端特定樣式 */
                overflow-x: scroll;   /* 水平捲動軸軌道常駐 */
                overflow-y: auto;     /* 如果表格內容太高，則顯示垂直捲動軸 */
                max-height: 65vh;     /* 設定表格容器本身的最大高度，例如視窗高度的65%。
                                         這樣非常長的表格會在此容器內滾動，而不是無限撐開主內容區。
                                         您可以根據需要調整此數值。 */
                padding-bottom: 10px; /* 為可能的水平捲動軸留出一些空間，避免遮擋最後一行數據 */
            }
        }
        @media (min-width: 1280px) { /* xl */
            .ios-app-container {
                max-width: 1140px; 
                border-radius: 32px; 
            }
            /* .ios-list 的樣式會從 lg 斷點繼承，如有需要可在此處覆寫 */
        }

        .page {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .ios-header {
            background-color: #f8f8f8; 
            padding: 12px 16px;
            border-bottom: 1px solid #d1d1d1;
            display: flex;
            justify-content: space-between;
            align-items: center;
            min-height: 50px; 
            flex-shrink: 0; 
        }
        .ios-header-title { font-size: 1.1rem; font-weight: 600; color: #000; }
        .ios-content { /* 主內容區域 */
            padding: 16px;
            overflow-y: auto; /* 如果整體內容 (包括按鈕、搜尋框、表格容器) 超出，則此處會垂直捲動 */
            flex-grow: 1;     
            background-color: #f9f9f9;
            -webkit-overflow-scrolling: touch; 
        }
        .ios-input {
            width: 100%; padding: 12px 15px; border: 1px solid #e0e0e0;
            border-radius: 8px; font-size: 1rem; margin-bottom: 16px;
            box-shadow: inset 0 1px 2px rgba(0,0,0,0.05);
        }
        .ios-input:focus { outline: none; border-color: #007aff; box-shadow: 0 0 0 2px rgba(0,122,255,0.2); }
        .ios-button {
            background-color: #007aff; color: white; padding: 12px 20px;
            border: none; border-radius: 8px; font-size: 1rem; font-weight: 500;
            cursor: pointer; text-align: center; transition: background-color 0.2s; width: 100%;
        }
        .ios-button:hover { background-color: #005bb5; }
        
        /* 工作表按鈕樣式 */
        .sheet-button {
            background-color: #e5e5ea;
            color: #007aff;
            padding: 8px 12px;
            border: 1px solid #d1d1d6;
            border-radius: 8px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: background-color 0.2s, color 0.2s, border-color 0.2s;
            margin-right: 8px;
            margin-bottom: 8px;
        }
        .sheet-button:hover {
            background-color: #dcdce0;
        }
        .sheet-button.active { /* 目前選定的工作表按鈕樣式 */
            background-color: #007aff;
            color: white;
            border-color: #007aff;
            font-weight: 500;
        }
        #sheetButtonsContainer {
            display: flex;
            flex-wrap: wrap; 
            margin-bottom: 16px;
            padding-bottom: 8px; 
            max-height: 100px; 
            overflow-y: auto; 
        }
        
        .ios-list { /* 表格容器的通用樣式 */
            overflow-x: auto; /* 預設在小螢幕上，內容超出才顯示水平捲動軸 */
            -webkit-overflow-scrolling: touch; 
            border-radius: 8px; 
            background-color: #fff; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.05); 
        }
        .ios-list table { width: 100%; border-collapse: collapse; }
        .ios-list th, .ios-list td {
            padding: 10px 12px; text-align: left; border-bottom: 1px solid #e0e0e0;
            font-size: 0.9rem; white-space: nowrap; 
        }
        .ios-list th {
            background-color: #f0f0f0; font-weight: 500; color: #555;
            position: sticky; top: 0; z-index: 1; /* 表頭在垂直捲動時固定 (如果.ios-list本身滾動) */
        }
        .ios-list td { background-color: #fff; color: #333; }
        .ios-list tr:last-child td { border-bottom: none; }
        .ios-list .no-results {
            padding: 20px; text-align: center; color: #888;
            background-color: #fff; white-space: normal; 
        }
        .hidden { display: none !important; }
        .loader {
            border: 4px solid #f3f3f3; border-top: 4px solid #007aff;
            border-radius: 50%; width: 30px; height: 30px;
            animation: spin 1s linear infinite; margin: 20px auto;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div id="app" class="ios-app-container">
        <div id="loginPage" class="page p-8 flex flex-col justify-center">
            <h1 class="text-3xl font-bold text-center mb-8 text-gray-800">產品查詢系統</h1>
            <p class="text-center mb-6">請登入以繼續：</p>
            <button id="auth0LoginButton" class="ios-button">使用 Auth0 登入 / 註冊</button>
            <div id="authError" class="text-red-500 text-center mt-4 hidden"></div>
        </div>

        <div id="mainPage" class="page hidden">
            <header class="ios-header">
                <h1 class="ios-header-title">產品查詢</h1>
                <button id="logoutButton" class="text-sm text-red-500 hover:text-red-700 font-medium">登出</button>
            </header>
            <main class="ios-content">
                <div id="sheetButtonsContainer" class="mb-4">
                    <p id="sheetLoadingMessage" class="text-gray-500 text-sm">正在載入工作表清單...</p>
                </div>
                <div class="mb-4">
                    <input type="text" id="searchInput" placeholder="輸入關鍵字搜尋產品..." class="ios-input">
                </div>
                <div id="loadingIndicator" class="hidden">
                    <div class="loader"></div>
                    <p class="text-center text-gray-600">正在載入資料...</p>
                </div>
                <div id="errorMessage" class="hidden p-4 text-center text-red-600 bg-red-100 rounded-lg"></div>
                <div id="resultsList" class="ios-list">
                    </div>
            </main>
        </div>
    </div>

    <script>
        // DOM 元素
        const loginPage = document.getElementById('loginPage');
        const mainPage = document.getElementById('mainPage');
        const auth0LoginButton = document.getElementById('auth0LoginButton');
        const logoutButton = document.getElementById('logoutButton');
        const sheetButtonsContainer = document.getElementById('sheetButtonsContainer'); 
        const sheetLoadingMessage = document.getElementById('sheetLoadingMessage'); 
        const searchInput = document.getElementById('searchInput');
        const resultsList = document.getElementById('resultsList');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const generalErrorMessage = document.getElementById('errorMessage');
        const authErrorDisplay = document.getElementById('authError');

        // Google Sheet 設定
        const SHEET_ID = '1sxAYg3k2ZDV8zulv67U1O9TS5NF5cuMfuisHWz8FXkU';
        // !!! 請務必替換成您自己的 Google Cloud API 金鑰 !!!
        const GOOGLE_API_KEY = 'YOUR_GOOGLE_CLOUD_API_KEY'; // <--- 在此填入您的 API 金鑰
        const DEFAULT_SHEET_NAME = '20250514'; 
        let currentSheetName = DEFAULT_SHEET_NAME; 
        let sheetData = { headers: [], data: [] };
        let allSheetNames = []; 

        // Auth0 設定 - !!! 請務必替換成您自己的 Auth0 Domain 和 Client ID !!!
        const auth0Domain = 'dev-mcspzgwngm55kx82.us.auth0.com';        
        const auth0ClientId = 'cB8W5yIJAcqDSizDY3hvwd3J0ZrKPqRb'; 
        const auth0RedirectUri = 'https://sheetseekerey.netlify.app';
        let auth0Client = null;

        // --- Auth0 相關函數 (保持不變) ---
        async function configureClient() {
            try {
                auth0Client = await auth0.createAuth0Client({
                    domain: auth0Domain, clientId: auth0ClientId,
                    authorizationParams: { redirect_uri: auth0RedirectUri, },
                    cacheLocation: 'localstorage'
                });
                console.log('Auth0 client configured successfully.');
                return auth0Client;
            } catch (e) {
                console.error('Error configuring Auth0 client:', e);
                if (authErrorDisplay) {
                    authErrorDisplay.textContent = 'Auth0 初始化失敗: ' + e.message;
                    authErrorDisplay.classList.remove('hidden');
                }
                return null;
            }
        }
        async function updateUI() {
            if (!auth0Client) { console.warn('Auth0 client not initialized. Showing login page.'); showLoginPage(); return; }
            try {
                const isAuthenticated = await auth0Client.isAuthenticated();
                console.log('Is Authenticated:', isAuthenticated);
                if (isAuthenticated) {
                    const user = await auth0Client.getUser();
                    console.log('Authenticated User:', user);
                    showMainPage(user);
                } else {
                    console.log('User is not authenticated. Showing login page.');
                    showLoginPage();
                }
            } catch (e) { console.error('Error updating UI:', e); showLoginPage(); }
        }
        async function login() {
            if (!auth0Client) {
                console.error('Auth0 client not initialized for login');
                if (authErrorDisplay) { authErrorDisplay.textContent = 'Auth0 服務尚未準備就緒。'; authErrorDisplay.classList.remove('hidden'); }
                return;
            }
            try { await auth0Client.loginWithRedirect(); }
            catch (e) { console.error('Login failed:', e); if (authErrorDisplay) { authErrorDisplay.textContent = '登入失敗: ' + e.message; authErrorDisplay.classList.remove('hidden'); } }
        }
        function doLogout() {
            if (!auth0Client) { console.error('Auth0 client not initialized for logout'); return; }
            try { auth0Client.logout({ logoutParams: { returnTo: auth0RedirectUri } }); }
            catch (e) { console.error('Logout failed:', e); }
        }

        // --- 頁面顯示邏輯 ---
        function showLoginPage() {
            console.log("Showing Login Page");
            if (loginPage && mainPage) { loginPage.classList.remove('hidden'); mainPage.classList.add('hidden'); }
            if (authErrorDisplay) authErrorDisplay.classList.add('hidden');
            if (generalErrorMessage) generalErrorMessage.classList.add('hidden');
            if (resultsList) resultsList.innerHTML = '';
            if (searchInput) searchInput.value = '';
            if (sheetButtonsContainer) sheetButtonsContainer.innerHTML = `<p id="sheetLoadingMessage" class="text-gray-500 text-sm">正在載入工作表清單...</p>`; 
            currentSheetName = DEFAULT_SHEET_NAME;
            sheetData = { headers: [], data: [] };
            allSheetNames = [];
        }

        function showMainPage(user) {
            console.log("Showing Main Page for user:", user ? (user.name || user.email) : "Unknown");
            if (loginPage && mainPage) {
                loginPage.classList.add('hidden');
                mainPage.classList.remove('hidden');
                fetchAndDisplaySheetNames(); 
            }
        }

        // --- Google Sheet 資料處理函數 ---
        async function fetchAndDisplaySheetNames() {
            if (GOOGLE_API_KEY === '041ccc54cd4aa0423a3a78518c1e50675ddcb7fc') {
                console.error("Google API Key 尚未設定。請在 JavaScript 中填寫 GOOGLE_API_KEY。");
                if(sheetLoadingMessage) sheetLoadingMessage.textContent = 'Google API Key 未設定，無法載入工作表清單。';
                generalErrorMessage.textContent = 'Google API Key 未設定，無法載入工作表清單。';
                generalErrorMessage.classList.remove('hidden');
                return;
            }
            if(sheetLoadingMessage) sheetLoadingMessage.textContent = '正在載入工作表清單...';

            const sheetsApiUrl = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}?key=${GOOGLE_API_KEY}&fields=sheets.properties.title`;
            console.log(`Fetching sheet names from: ${sheetsApiUrl}`);

            try {
                const response = await fetch(sheetsApiUrl);
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ message: response.statusText }));
                    throw new Error(`無法獲取工作表清單: ${response.status} ${errorData.error?.message || errorData.message || response.statusText}`);
                }
                const data = await response.json();
                allSheetNames = data.sheets.map(sheet => sheet.properties.title);
                console.log('Available sheets:', allSheetNames);

                sheetButtonsContainer.innerHTML = ''; 
                if (allSheetNames.length === 0) {
                    sheetButtonsContainer.innerHTML = '<p class="text-gray-500 text-sm">此試算表中沒有找到任何工作表。</p>';
                    return;
                }

                allSheetNames.forEach(name => {
                    const button = document.createElement('button');
                    button.textContent = name;
                    button.classList.add('sheet-button');
                    button.addEventListener('click', () => {
                        document.querySelectorAll('.sheet-button.active').forEach(activeBtn => {
                            activeBtn.classList.remove('active');
                        });
                        button.classList.add('active');
                        currentSheetName = name;
                        console.log(`Sheet selected: ${currentSheetName}`);
                        searchInput.value = ''; 
                        resultsList.innerHTML = ''; 
                        fetchSheetData(); 
                    });
                    sheetButtonsContainer.appendChild(button);
                });

                if (allSheetNames.includes(DEFAULT_SHEET_NAME)) {
                    currentSheetName = DEFAULT_SHEET_NAME;
                    const defaultSheetButton = Array.from(sheetButtonsContainer.querySelectorAll('.sheet-button')).find(btn => btn.textContent === DEFAULT_SHEET_NAME);
                    if (defaultSheetButton) { defaultSheetButton.click(); } 
                    else { fetchSheetData(); }
                } else if (allSheetNames.length > 0) {
                    console.log('預設工作表未找到，將載入第一個工作表。');
                    const firstSheetButton = sheetButtonsContainer.querySelector('.sheet-button');
                    if (firstSheetButton) { firstSheetButton.click(); }
                }
            } catch (error) {
                console.error("獲取工作表名稱時發生錯誤:", error);
                if(sheetLoadingMessage) sheetLoadingMessage.style.display = 'none'; 
                generalErrorMessage.textContent = `獲取工作表清單失敗: ${error.message}`;
                generalErrorMessage.classList.remove('hidden');
                sheetButtonsContainer.innerHTML = '<p class="text-red-500 text-sm">無法載入工作表清單。</p>';
            }
        }

        function parseCSVLine(line) { 
            const regex = /(?:\"([^\"]*(?:\"\"[^\"]*)*)\"|([^\",]+))/g;
            let values = []; let match;
            while (match = regex.exec(line)) {
                values.push(match[1] !== undefined ? match[1].replace(/\"\"/g, '\"') : match[2]);
            }
            return values;
        }
        function parseCSV(csvText) { 
            if (typeof csvText !== 'string') { console.error("parseCSV 接收到的不是字串:", csvText); return { headers: [], data: [] }; }
            const lines = csvText.trim().split('\n'); const data = []; let headers = [];
            if (lines.length > 0) {
                headers = parseCSVLine(lines[0]);
                for (let i = 1; i < lines.length; i++) {
                    if (lines[i].trim() === "") continue;
                    const cells = parseCSVLine(lines[i]);
                    if (cells.length === headers.length && cells.some(cell => cell && cell.trim() !== "")) {
                        let rowObject = {};
                        headers.forEach((header, index) => { rowObject[header] = cells[index] || ''; });
                        data.push(rowObject);
                    } else { console.warn(`parseCSV: 第 ${i+1} 行資料欄位數 (${cells.length}) 與表頭 (${headers.length}) 不符，已跳過:`, lines[i]); }
                }
            }
            return { headers, data };
        }

        async function fetchSheetData() { 
            if (!loadingIndicator || !generalErrorMessage || !resultsList) { console.error('fetchSheetData: UI 元素未找到!'); return; }
            if (!currentSheetName) {
                generalErrorMessage.textContent = '尚未選擇工作表。';
                generalErrorMessage.classList.remove('hidden');
                return;
            }
            const dynamicApiUrl = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(currentSheetName)}`;
            console.log(`Fetching data for sheet "${currentSheetName}" from: ${dynamicApiUrl}`);
            loadingIndicator.classList.remove('hidden');
            generalErrorMessage.classList.add('hidden');
            resultsList.innerHTML = ''; 
            sheetData = { headers: [], data: [] }; 
            try {
                const response = await fetch(dynamicApiUrl);
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`無法載入資料 (${currentSheetName}): ${response.status} ${response.statusText}. Server: ${errorText.substring(0,100)}`);
                }
                const csvText = await response.text();
                sheetData = parseCSV(csvText);
                if (!sheetData.headers || sheetData.headers.length === 0) { throw new Error(`無法解析工作表 "${currentSheetName}" 的表頭或工作表為空。`); }
                if (sheetData.data.length === 0) { resultsList.innerHTML = `<div class="no-results">工作表 "${currentSheetName}" 中目前沒有資料。</div>`; }
                else { displayResults(sheetData.data); }
            } catch (error) {
                console.error("fetchSheetData 錯誤:", error);
                generalErrorMessage.textContent = `讀取產品資料錯誤: ${error.message}`;
                generalErrorMessage.classList.remove('hidden');
                resultsList.innerHTML = `<div class="no-results">無法載入工作表 "${currentSheetName}" 的資料。</div>`;
            } finally {
                loadingIndicator.classList.add('hidden');
            }
        }

        function filterAndDisplayData() { 
            const searchTerm = searchInput.value.toLowerCase().trim();
            if (!sheetData.data || sheetData.data.length === 0) {
                if (loadingIndicator && !loadingIndicator.classList.contains('hidden')) return;
                resultsList.innerHTML = `<div class="no-results">工作表 "${currentSheetName}" 中沒有可供搜尋的資料。</div>`; return;
            }
            const filteredData = sheetData.data.filter(row => 
                !searchTerm || Object.values(row).some(value => String(value).toLowerCase().includes(searchTerm))
            );
            displayResults(filteredData);
        }
        
        function escapeHTML(str) { 
            if (str === null || str === undefined) return '';
            return String(str).replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
        }

        function displayResults(dataToDisplay) { 
            resultsList.innerHTML = ''; 
            if (generalErrorMessage) generalErrorMessage.classList.add('hidden');
            if (dataToDisplay.length === 0) { resultsList.innerHTML = `<div class="no-results">在工作表 "${currentSheetName}" 中未找到符合條件的產品。</div>`; return; }
            const table = document.createElement('table'); const thead = document.createElement('thead');
            let headerRowHtml = '<tr>'; sheetData.headers.forEach(header => { headerRowHtml += `<th>${escapeHTML(header)}</th>`; });
            headerRowHtml += '</tr>'; thead.innerHTML = headerRowHtml; table.appendChild(thead);
            const tbody = document.createElement('tbody');
            dataToDisplay.forEach(rowObject => {
                let rowHtml = '<tr>'; sheetData.headers.forEach(header => { rowHtml += `<td>${escapeHTML(rowObject[header])}</td>`; });
                rowHtml += '</tr>'; tbody.innerHTML += rowHtml;
            });
            table.appendChild(tbody); resultsList.appendChild(table);
        }

        // --- 事件監聽 ---
        if (auth0LoginButton) { auth0LoginButton.addEventListener('click', login); } 
        else { console.error("'auth0LoginButton' not found."); }
        if (logoutButton) { logoutButton.addEventListener('click', doLogout); } 
        else { console.error("'logoutButton' not found."); }
        if (searchInput) {
            let searchTimeout;
            searchInput.addEventListener('input', () => {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(filterAndDisplayData, 300);
            });
        } else { console.error("'searchInput' not found."); }

        // --- 應用程式初始化 ---
        window.addEventListener('load', async () => {
            console.log('Window loaded. Configuring Auth0 client...');
            if (auth0Domain === 'YOUR_AUTH0_DOMAIN' || auth0ClientId === 'YOUR_AUTH0_CLIENT_ID') {
                console.error("Auth0 Domain 或 Client ID 尚未設定。");
                if (authErrorDisplay) { authErrorDisplay.textContent = "Auth0 設定不完整。"; authErrorDisplay.classList.remove('hidden');}
                showLoginPage(); return; 
            }
            if (GOOGLE_API_KEY === 'YOUR_GOOGLE_CLOUD_API_KEY') {
                 console.warn("Google API Key 尚未設定。工作表清單功能將無法使用。");
            }
            auth0Client = await configureClient();
            if (auth0Client) {
                const query = window.location.search;
                if (query.includes("code=") && query.includes("state=")) {
                    console.log('Found redirect callback params. Handling redirect...');
                    try {
                        await auth0Client.handleRedirectCallback();
                        console.log('Redirect callback handled.');
                        window.history.replaceState({}, document.title, window.location.pathname);
                    } catch (e) {
                        console.error('Error handling redirect callback:', e);
                        if (authErrorDisplay) { authErrorDisplay.textContent = '處理登入回呼時發生錯誤: ' + e.message; authErrorDisplay.classList.remove('hidden');}
                    }
                }
                await updateUI(); 
            } else {
                showLoginPage(); 
            }
        });
    </script>
</body>
</html>
